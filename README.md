# ğŸš€Id Server
[Id Server](https://github.com/NotFound403/id-server)æ˜¯ä¸€ä¸ªåŸºäº[Spring Authorization Server](https://github.com/spring-projects/spring-authorization-server)çš„å¼€æºçš„æˆæƒæœåŠ¡å™¨ï¼Œæ‹‰å–ä»£ç ç›´æ¥è¿è¡Œï¼Œæ— éœ€è¿‡å¤šé…ç½®ã€‚æ¬¢è¿Starï¼Œå¦‚æœæœ‰å…´è¶£ä¹Ÿå¯ä»¥å¯¹æœ¬é¡¹ç›®å‘èµ·è´¡çŒ®ã€‚
- github: [https://github.com/NotFound403/id-server](https://github.com/NotFound403/id-server)
- gitee: [https://gitee.com/felord/id-server](https://gitee.com/felord/id-server)
- æ–‡æ¡£å»ºè®¾ä¸­â€¦â€¦
## ä¸»è¦åŠŸèƒ½
- å¼€ç®±å³ç”¨ï¼Œåªéœ€è¦å°‘é‡é…ç½®å³å¯ä½¿ç”¨ã€‚
- åˆ›å»ºOAuth2å®¢æˆ·ç«¯ï¼Œå¹¶å¯¹OAuth2å®¢æˆ·ç«¯è¿›è¡Œç®¡ç†ã€‚
- æä¾›OAuth2æˆæƒæœåŠ¡ã€‚
- æ”¯æŒå››ç§å®¢æˆ·ç«¯è®¤è¯æ–¹å¼ï¼š
  - **CLIENT_SECRET_BASIC**
  - **CLIENT_SECRET_POST**
  - **CLIENT_SECRET_JWT**
  - **PRIVATE_KEY_JWT**
- æ”¯æŒä¸‰ç§OAuth2æˆæƒæ–¹å¼ï¼š
  - **AUTHORIZATION_CODE**
  - **CLIENT_CREDENTIALS**
  - **REFRESH_TOKEN**
- æ”¯æŒä»¥ä¸‹ç”¨æˆ·è®¤è¯æ–¹å¼ï¼š
  - è´¦å¯†ç™»å½•
  - æ‰‹æœºå·éªŒè¯ç ç™»å½•
  - å°ç¨‹åºç™»å½•
- **OIDC 1.0**çš„æ”¯æŒï¼ˆå®Œå–„ä¸­ï¼‰ã€‚
- ä¸€é”®ç”Ÿæˆé…ç½®`yaml`æ–‡ä»¶ã€‚
- æä¾›UIæ§åˆ¶å°ï¼Œé™ä½ä¸Šæ‰‹æˆæœ¬ã€‚
- å¯åŠ¨æ€è°ƒæ•´ç®¡ç†å‘˜çš„ç”¨æˆ·è§’è‰²ï¼Œå¯¹æˆæƒæœåŠ¡å™¨è¿›è¡ŒæŒ‰é’®åŠŸèƒ½çº§åˆ«çš„æƒé™æ§åˆ¶ã€‚
## ç¯å¢ƒä¸æŠ€æœ¯
- Java 8åŠä»¥ä¸Š
- **Spring Boot**
- **Spring Security**
- **Spring Authorization Server**
- **Spring Data JPA**
- **pear admin layui**
- **thymeleaf**
- æ•°æ®åº“
  - **H2**
  - **Mysql**

## ç®€å•ç”¨æ³•
- æ‹‰å–ä¸»åˆ†æ”¯æœ€æ–°ä»£ç åˆ°æœ¬åœ°ã€‚
- é€šè¿‡`IdServerApplication`æ¥å¯åŠ¨æˆæƒæœåŠ¡å™¨ã€‚ç®¡ç†æ§åˆ¶å°æœ¬åœ°ç™»å½•è·¯å¾„ä¸º`http://localhost:9000/system/login`ï¼Œæœ€é«˜æƒé™ç”¨æˆ·ä¸º`root`ï¼Œå¯†ç ä¸º`idserver`ã€‚
- ä½ å¯ä»¥é€šè¿‡`root`ç”¨æˆ·åšè¿™äº›äº‹æƒ…ï¼š
  - åˆ›å»ºè§’è‰²ï¼ˆè§’è‰²ç®¡ç†ï¼‰å¹¶ä¸ºè§’è‰²ç»‘å®šæƒé™ã€‚
  - åˆ›å»ºæ§åˆ¶å°ç®¡ç†ç”¨æˆ·ï¼ˆç”¨æˆ·ç®¡ç†ï¼‰ï¼Œå¹¶èµ‹äºˆä»–ä»¬è§’è‰²ã€‚
> é€€å‡ºåŠŸèƒ½è¿˜æœªå®Œå–„ï¼Œéœ€è¦é€šè¿‡å…³é—­æµè§ˆå™¨æ¥æ¸…é™¤sessionã€‚
## OAuth2 æµ‹è¯•æ–¹æ³•
- å¯åŠ¨**Id Server**ï¼Œé»˜è®¤æƒ…å†µä¸‹åœ¨å®¢æˆ·ç«¯åˆ—è¡¨æä¾›äº†ä¸€ä¸ªå†…ç½®çš„OAuth2å®¢æˆ·ç«¯ã€‚
- æ ·ä¾‹å®¢æˆ·ç«¯åœ¨`samples`æ–‡ä»¶å¤¹ä¸‹ï¼Œç›´æ¥å¯åŠ¨ï¼Œæµè§ˆå™¨é…ç½®æ–‡ä»¶ä¸‹çš„`http://127.0.0.1:8082/foo/bar`ï¼Œè¿›å…¥ç™»å½•é¡µï¼Œè¾“å…¥ç”¨æˆ·å`user`å’Œå¯†ç `user`å³å¯ã€‚
- ä½ ä¹Ÿå¯ä»¥åœ¨Id Serverä¸­åˆ›å»ºä¸€ä¸ªå®¢æˆ·ç«¯å¹¶æ¨¡ä»¿DEMOä¸­çš„é…ç½®ï¼Œä¸»è¦ä¿®æ”¹`client-id`,`client-secret`,`client-authentication-method`,`scope`ï¼Œå…¶å®ƒé€‰é¡¹é™¤éä½ æ¯”è¾ƒäº†è§£OAuth2ï¼Œå¦åˆ™å…ˆä¸è¦åŠ¨ï¼Œä¹Ÿå¯ä»¥é€šè¿‡issueå’¨è¯¢ã€‚
> `redirect-uri`å¿…é¡»åœ¨æˆæƒæœåŠ¡å™¨Id Serveræ³¨å†Œå®¢æˆ·ç«¯æ—¶å£°æ˜ã€‚
### å¦‚ä½•æ›¿æ¢å†…ç½®ç”¨æˆ·user
é¦–å…ˆè¦æ­£ç¡®åŒºåˆ†**ç®¡ç†ç”¨æˆ·**å’Œ**æ™®é€šç”¨æˆ·**è¿™ä¸¤ä¸ªæ¦‚å¿µã€‚
#### ç®¡ç†ç”¨æˆ·
`root`åŠå…¶åˆ›å»ºçš„ç”¨æˆ·ä¸ºUIæ§åˆ¶å°çš„ç®¡ç†ç”¨æˆ·ï¼Œè¶…çº§ç®¡ç†å‘˜`root`æ˜¯ç›®å‰æä¾›äº†ä¸€ä¸ªé»˜è®¤ç”¨æˆ·ï¼Œå…·æœ‰Id Serverçš„æœ€é«˜æƒé™ã€‚å¦‚æœä½ éœ€è¦è‡ªå®šä¹‰ï¼Œå¯å®ç°`RootUserDetailsService`æ¥å£å¹¶æ³¨å…¥**Spring IoC**ã€‚
#### æ™®é€šç”¨æˆ·
æ™®é€šç”¨æˆ·å°±æ˜¯OAuth2ä¸­çš„èµ„æºæ‹¥æœ‰è€…ï¼Œä¸»è¦å¯¹OAuth2å®¢æˆ·ç«¯çš„æˆæƒè¯·æ±‚è¿›è¡Œæˆæƒã€‚é»˜è®¤æä¾›äº†ä¸€ä¸ª`user`ç”¨æ¥æ¼”ç¤ºï¼Œå¼€å‘è€…å¯ä»¥å®ç°`OAuth2UserDetailsService`æ¥å£å¹¶æ³¨å…¥**Spring IoC**æ¥è‡ªå®šä¹‰ç”¨æˆ·çš„æ¥æºã€‚
### æ‰‹æœºå·éªŒè¯ç ç™»å½•
ç°åœ¨OAuth2æˆæƒå¢åŠ äº†æ‰‹æœºå·éªŒè¯ç ç™»å½•ï¼Œçµæ„Ÿæ¥è‡ª[]()æ‰©å±•åŒ…ï¼Œä¸å½±å“åŸæœ‰çš„OAuth2æˆæƒæµç¨‹ã€‚èµ„æºæ‹¥æœ‰è€…å¯ä»¥åœ¨ä¸‹é¢çš„é¡µé¢é€‰æ‹©è®¤è¯æ–¹å¼ï¼š
![](https://asset.felord.cn/blog/20220520111451.png)
#### å…³é—­éªŒè¯ç è®¤è¯æ–¹å¼
å¯¹äºä¸ä½¿ç”¨éªŒè¯ç è®¤è¯æ–¹å¼çš„ï¼Œå¯ä»¥é€šè¿‡`OAuth2LoginController#oauth2LoginPage`æ¥å£ä¸­çš„`enableCaptchaLogin`å‚æ•°è¿›è¡Œè°ƒæ•´ï¼Œé»˜è®¤å€¼ä¸º`true`ï¼ˆå¼€å¯ï¼‰ã€‚
## ç¯å¢ƒ
ç›®å‰**Id Server**æä¾›**H2**å’Œ**Mysql**ä¸¤ç§æ•°æ®åº“ç¯å¢ƒï¼Œåˆ†åˆ«å¯¹åº”`application-h2.yml`å’Œ`application-mysql.yml`ä¸¤ä¸ªé…ç½®æ–‡ä»¶ã€‚
- **H2**ï¼Œé»˜è®¤æ•°æ®åº“ï¼Œåœ¨**H2**ç¯å¢ƒä¸‹ï¼Œæ•°æ®åº“DDLè„šæœ¬å’ŒDMLè„šæœ¬ä¼šè‡ªåŠ¨æ‰§è¡Œï¼Œæ— éœ€å¼€å‘è€…æ‰‹åŠ¨æ‰§è¡Œï¼Œè¯¥ç¯å¢ƒä¸»è¦ç”¨æ¥æµ‹è¯•ã€ç ”ç©¶ã€å­¦ä¹ ã€‚
- **Mysql**ï¼Œç”Ÿäº§æ¨èï¼Œ**é¦–æ¬¡å¯åŠ¨æ—¶å¼€å‘è€…æ‰‹åŠ¨æ‰§è¡Œåˆå§‹åŒ–DMLè„šæœ¬**ã€‚
> ç›®å‰ä¸¤ç§ç¯å¢ƒçš„æ•ˆæœæ˜¯ä¸€è‡´çš„ï¼ŒH2æ—¶é—´é•¿ä¼šå‘ç”Ÿè¡¨ä¸¢å¤±æƒ…å†µï¼Œåˆ‡æ¢æ—¶åŠ¡å¿…åœ¨`pom.xml`ä¸­æ›´æ¢å¯¹åº”çš„æ•°æ®åº“é©±åŠ¨ç¨‹åºä¾èµ–ã€‚
## æˆªå›¾
![æ§åˆ¶å°å°ç™»å½•](https://asset.felord.cn/blog/20220512143700.png)
![é¦–é¡µ](https://asset.felord.cn/blog/20220512134905.png)
![é€šè¿‡UIåˆ›å»ºOAuth2å®¢æˆ·ç«¯](https://asset.felord.cn/blog/20220512135204.png)
![åˆ›å»ºç®¡ç†ç”¨æˆ·](https://asset.felord.cn/blog/20220512135249.png)
![ä¸€é”®ç”Ÿæˆé…ç½®](https://asset.felord.cn/blog/20220513141607.gif)
![è§’è‰²æˆæƒ](https://asset.felord.cn/blog/20220512135420.png)
![æˆæƒç™»å½•](https://asset.felord.cn/blog/20220512143317.png)
![æˆæƒç¡®è®¤](https://asset.felord.cn/blog/20220512143550.png)


