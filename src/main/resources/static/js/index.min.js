;

jQuery(function () {
    $("body").on('click', '[data-stopPropagation]', function (e) {
        e.stopPropagation();
    });

    // 滚动条
    const ps = new PerfectScrollbar('.lyear-layout-sidebar-scroll', {
        swipeEasing: false,
        suppressScrollX: true
    });

    // 侧边栏
    $(document).on('click', '.lyear-aside-toggler', function () {
        $('.lyear-layout-sidebar').toggleClass('lyear-aside-open');
        $("body").toggleClass('lyear-layout-sidebar-close');

        if ($('.lyear-mask-modal').length == 0) {
            $('<div class="lyear-mask-modal"></div>').prependTo('body');
        } else {
            $('.lyear-mask-modal').remove();
        }
    });

    // 遮罩层
    $(document).on('click', '.lyear-mask-modal', function () {
        $(this).remove();
        $('.lyear-layout-sidebar').toggleClass('lyear-aside-open');
        $('body').toggleClass('lyear-layout-sidebar-close');
    });

    // 侧边栏导航
    $(document).on('click', '.nav-item-has-subnav > a', function () {
        $subnavToggle = jQuery(this);
        $navHasSubnav = $subnavToggle.parent();
        $topHasSubNav = $subnavToggle.parents('.nav-item-has-subnav').last();
        $subnav = $navHasSubnav.find('.nav-subnav').first();
        $viSubHeight = $navHasSubnav.siblings().find('.nav-subnav:visible').outerHeight();
        $scrollBox = $('.lyear-layout-sidebar-scroll');
        $navHasSubnav.siblings().find('.nav-subnav:visible').slideUp(500).parent().removeClass('open');
        $subnav.slideToggle(300, function () {
            $navHasSubnav.toggleClass('open');

            // 新增滚动条处理
            var scrollHeight = 0;
            pervTotal = $topHasSubNav.prevAll().length,
                boxHeight = $scrollBox.outerHeight(),
                innerHeight = $('.sidebar-main').outerHeight(),
                thisScroll = $scrollBox.scrollTop(),
                thisSubHeight = $(this).outerHeight(),
                footHeight = 121;

            if (footHeight + innerHeight - boxHeight >= (pervTotal * 48)) {
                scrollHeight = pervTotal * 48;
            }
            if ($subnavToggle.parents('.nav-item-has-subnav').length == 1) {
                $scrollBox.animate({scrollTop: scrollHeight}, 300);
            } else {
                // 子菜单操作
                if (typeof ($viSubHeight) != 'undefined' && $viSubHeight != null) {
                    scrollHeight = thisScroll + thisSubHeight - $viSubHeight;
                    $scrollBox.animate({scrollTop: scrollHeight}, 300);
                } else {
                    if ((thisScroll + boxHeight - $scrollBox[0].scrollHeight) == 0) {
                        scrollHeight = thisScroll - thisSubHeight;
                        $scrollBox.animate({scrollTop: scrollHeight}, 300);
                    }
                }
            }
        });
    });

    // 设置主题配色
    setTheme = function (input_name, data_name) {
        $("input[name='" + input_name + "']").click(function () {
            $('body').attr(data_name, $(this).val());
        });
    }
    setTheme('logo_bg', 'data-logobg');
    setTheme('header_bg', 'data-headerbg');
    setTheme('sidebar_bg', 'data-sidebarbg');

    // 选项卡
    $('#iframe-content').multitabs({
        iframe: true,
        nav: {
            backgroundColor: '#ffffff',
        },
        init: [{
            type: 'main',
            title: '首页',
            url: 'lyear_main.html'
        }]
    });

    $(document).on('click', '.nav-item .multitabs', function () {
        $('.nav-item').removeClass('active');
        $('.nav-subnav li').removeClass('active');
        $(this).parents('li').addClass('active');
        $(this).parents('.nav-item-has-subnav').addClass('open').first().addClass('active');
    });
});





var menu=[{"id":"1","name":"后台首页","url":"lyear-main.html","pid":0,"icon":"mdi mdi-home","is_out":0,"is_home":1},{"id":"2","name":"UI 元素","url":"#","pid":0,"icon":"mdi mdi-palette","is_out":0,"is_home":0},{"id":"3","name":"按钮","url":"lyear_ui_buttons.html","pid":2,"icon":"","is_out":0,"is_home":0},{"id":"4","name":"卡片","url":"lyear_ui_cards.html","pid":2,"icon":"","is_out":0,"is_home":0},{"id":"5","name":"格栅","url":"lyear_ui_grid.html","pid":2,"icon":"","is_out":0,"is_home":0},{"id":"6","name":"多级菜单","url":"#","pid":0,"icon":"mdi mdi-menu","is_out":0,"is_home":0},{"id":"7","name":"一级菜单","url":"#!","pid":6,"icon":"","is_out":0,"is_home":0},{"id":"8","name":"一级菜单","url":"#!","pid":6,"icon":"","is_out":0,"is_home":0},{"id":"9","name":"二级菜单","url":"#!","pid":8,"icon":"","is_out":0,"is_home":0},{"id":"10","name":"二级菜单","url":"#!","pid":8,"icon":"","is_out":0},{"id":"11","name":"三级菜单","url":"#!","pid":10,"icon":"","is_out":0,"is_home":0},{"id":"12","name":"三级菜单","url":"#!","pid":10,"icon":"","is_out":0,"is_home":0}];

/**
 * 菜单
 * @param data 菜单JSON数据
 *        id 菜单唯一ID
 *        name 菜单名称
 *        url 菜单链接地址
 *        icon 图标
 *        pid  父级ID
 *        is_out 是否外链0否|1是,外链a标签没有class='multitabs'
 *        is_home 是否首页
 */
var setSidebar = function (data) {
    if (data.length == 0) return false;
    var treeObj = treeData(data, 'id', 'pid', 'children');
    html = createMenu(treeObj, true);
    $('.sidebar-main').append(html);
}
var createMenu = function (data, is_frist) {
    var menu_body = is_frist ? '<ul class="nav-drawer">' : '<ul class="nav nav-subnav">';
    for (var i = 0; i < data.length; i++) {
        iframe_class = data[i].is_out == 1 ? '' : 'class="multitabs"';
        icon_div = data[i].pid == 0 ? '<i class="' + data[i].icon + '"></i>' : '';
        selected = (data[i].pid == 0) && (data[i].is_home == 1) ? 'active' : '';
        menuName = data[i].pid == 0 ? '<span>' + data[i].name + '</span>' : data[i].name;
        if (data[i].children && data[i].children.length > 0) {
            menu_body += '<li class="nav-item nav-item-has-subnav"><a href="javascript:void(0)">' + icon_div + menuName + '</a>';
            menu_body += createMenu(data[i].children);
        } else {
            menu_body += '<li class="nav-item ' + selected + '"><a href="' + data[i].url + '" ' + iframe_class + '>' + icon_div + menuName + '</a>';
        }
        menu_body += '</li>';
    }
    menu_body += '</ul>';
    return menu_body;
};
/**
 * @author CSDN 蔚莱先森
 * @param source json数据源
 * @param id 主键ID
 * @param parendId 父级ID名称
 * @param children 子级名称
 */
var treeData = function (source, id, parentId, children) {
    let cloneData = (typeof source == 'object') ? source : JSON.parse(source);
    return cloneData.filter(father => {
        let branchArr = cloneData.filter(child => father[id] == child[parentId]);
        branchArr.length > 0 ? father[children] = branchArr : ''
        return father[parentId] == 0
    })
}